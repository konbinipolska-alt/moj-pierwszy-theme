<div class="search-bar-container">
  <form action="{{ routes.search_url }}" method="get" class="search-form" role="search">
    <div class="search-input-wrapper">
      <span class="search-shortcut-hint" aria-label="Naciśnij / aby wyszukać">/</span>
      <div class="search-input-inner">
        <span class="search-caret" aria-hidden="true"></span>
        <input 
        type="search" 
        name="q" 
        id="search-input" 
        class="search-input" 
        placeholder="szukaj wg. nazwy, kategorii lub dania"
        autocomplete="off"
        aria-label="Szukaj produktów"
      />
      <button type="submit" class="search-submit" aria-label="Szukaj">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </button>
      </div>
    </div>
    <div class="search-suggestions" id="search-suggestions" role="listbox" aria-label="Sugestie wyszukiwania"></div>
  </form>
</div>

{% stylesheet %}
  .search-bar-container {
    width: 90%;
    max-width: 90%;
    margin: 0 2rem;
    position: relative;
  }

  .search-form {
    position: relative;
    width: 100%;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    padding-left: 22px;
  }

  .search-input-inner {
    position: relative;
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0;
    border: 1px solid rgba(11, 0, 181, 0);
    background: white;
    transition: border-color 0.2s ease;
    overflow: visible;
  }

  .search-input-wrapper:focus-within .search-input-inner {
    border: 2px solid #0b00b5;
  }

  .search-shortcut-hint {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 20px;
    min-width: 14px;
    min-height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(11, 0, 181, 0.2);
    border-radius: 3px;
    color: rgba(11, 0, 181, 0.5);
    font-size: 12px;
    font-weight: 500;
    font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    pointer-events: none;
    z-index: 10;
    line-height: 1;
    box-sizing: border-box;
    padding-left: 1px;
    transition: all 0.2s ease;
  }

  .search-shortcut-hint.highlighted {
    background-color: rgba(11, 0, 181, 0.1);
    border-color: rgba(11, 0, 181, 0.4);
    color: rgba(11, 0, 181, 0.8);
  }

  .search-caret {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 18px;
    background-color: rgba(11, 0, 181, 0.25);
    animation: blink 2s infinite;
    pointer-events: none;
    z-index: 1;
  }

  /* Hide shortcut hint and custom caret when input has focus (user is typing) or has text */
  .search-input-wrapper:has(.search-input:focus) .search-shortcut-hint,
  .search-input-wrapper:has(.search-input:not(:placeholder-shown)) .search-shortcut-hint,
  .search-input-wrapper:has(.search-input:focus) .search-caret,
  .search-input-wrapper:has(.search-input:not(:placeholder-shown)) .search-caret {
    display: none;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .search-input {
    flex: 1;
    padding: 12px 12px 12px 19px;
    border: none;
    outline: none;
    font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 16px;
    color: var(--color-primary);
    background: transparent;
    width: 100%;
    position: relative;
    z-index: 1;
  }

  .search-input::placeholder {
    color: rgba(11, 0, 181, 0.5);
  }

  .search-submit {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    color: rgba(11, 0, 181, 1);
    display: none;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
    flex-shrink: 0;
  }

  .search-input-inner:has(.search-input:not(:placeholder-shown)) .search-submit,
  .search-form:has(.search-input:not(:placeholder-shown)) .search-submit {
    display: flex;
  }

  .search-submit svg {
    width: 20px;
    height: 20px;
  }

  .search-submit:hover {
    opacity: 1;
  }

  .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid rgba(11, 0, 181, 0.5);
    border-top: none;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .search-suggestions.has-results {
    display: block;
  }

  .search-suggestion-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(11, 0, 181, 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background-color 0.2s ease;
    text-decoration: none;
    color: var(--color-primary);
  }

  .search-suggestion-item:hover,
  .search-suggestion-item[aria-selected="true"] {
    background-color: rgba(11, 0, 181, 0.05);
  }

  .search-suggestion-item:last-child {
    border-bottom: none;
  }

  .search-suggestion-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .search-suggestion-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .search-suggestion-title {
    font-weight: 500;
    font-size: 16px;
  }

  .search-suggestion-price {
    font-size: 14px;
    color: rgba(11, 0, 181, 0.7);
  }

  .search-suggestion-no-results {
    padding: 16px;
    text-align: center;
    color: rgba(11, 0, 181, 0.5);
    font-size: 14px;
  }

  @media (max-width: 768px) {
    .search-bar-container {
      max-width: 100%;
      margin: 0 1rem;
    }

    .search-shortcut-hint {
      display: none;
    }

    .search-caret {
      left: 12px;
    }

    .search-input {
      padding-left: 17px;
    }
  }
{% endstylesheet %}

<script>
  (function() {
    const searchInput = document.getElementById('search-input');
    const searchSuggestions = document.getElementById('search-suggestions');
    let debounceTimer;
    let currentRequest = null;
    let isSearchInputFocused = false;

    if (!searchInput || !searchSuggestions) return;

    // Get shortcut hint element
    const shortcutHint = document.querySelector('.search-shortcut-hint');

    // Keyboard shortcut: "/" to activate search (like GitHub, Linear, Notion)
    document.addEventListener('keydown', function(e) {
      // Only trigger if not typing in an input/textarea/contenteditable
      const isTyping = e.target.tagName === 'INPUT' || 
                      e.target.tagName === 'TEXTAREA' || 
                      e.target.isContentEditable;
      
      // Don't trigger if modifier keys are pressed (Ctrl, Alt, Meta, Shift)
      const hasModifier = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;
      
      // Highlight shortcut hint when "/" is pressed
      if (e.key === '/' && !isTyping && !isSearchInputFocused && !hasModifier && shortcutHint) {
        shortcutHint.classList.add('highlighted');
      }
      
      // Trigger on "/" key (but not if already in search input or typing elsewhere)
      if (e.key === '/' && !isTyping && !isSearchInputFocused && !hasModifier) {
        e.preventDefault();
        e.stopPropagation();
        
        // Focus the search input
        searchInput.focus();
        
        // If input has text, trigger search to show suggestions
        const currentValue = searchInput.value.trim();
        if (currentValue.length >= 2) {
          performSearch(currentValue);
        }
      }
      
      // Escape to blur search input and hide suggestions
      if (e.key === 'Escape' && isSearchInputFocused) {
        e.preventDefault();
        searchInput.blur();
        searchSuggestions.classList.remove('has-results');
        searchInput.value = '';
      }
    });

    // Remove highlight when "/" key is released
    document.addEventListener('keyup', function(e) {
      if (e.key === '/' && shortcutHint) {
        shortcutHint.classList.remove('highlighted');
      }
    });

    // Track focus state
    searchInput.addEventListener('focus', function() {
      isSearchInputFocused = true;
    });

    searchInput.addEventListener('blur', function() {
      isSearchInputFocused = false;
    });

    function performSearch(query) {
      if (!query || query.length < 2) {
        searchSuggestions.classList.remove('has-results');
        searchSuggestions.innerHTML = '';
        return;
      }

      // Cancel previous request if still pending
      if (currentRequest && currentRequest.abort) {
        currentRequest.abort();
      }

      // Show loading state
      searchSuggestions.innerHTML = '<div class="search-suggestion-no-results">Szukanie...</div>';
      searchSuggestions.classList.add('has-results');

      // Fetch search results from Shopify
      const url = `/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=5`;
      const controller = new AbortController();
      currentRequest = controller;
      
      fetch(url, { signal: controller.signal })
        .then(response => response.json())
        .then(data => {
          currentRequest = null;
          displaySuggestions(data, query);
        })
        .catch(error => {
          currentRequest = null;
          if (error.name !== 'AbortError') {
            console.error('Search error:', error);
            searchSuggestions.innerHTML = '<div class="search-suggestion-no-results">Błąd wyszukiwania</div>';
          }
        });
    }

    function displaySuggestions(data, query) {
      searchSuggestions.innerHTML = '';

      // Shopify search suggest API returns data in resources.results.products
      const products = data?.resources?.results?.products || [];
      
      if (!products || products.length === 0) {
        searchSuggestions.innerHTML = '<div class="search-suggestion-no-results">Brak wyników</div>';
        searchSuggestions.classList.add('has-results');
        return;
      }
      let selectedIndex = -1;

      products.forEach((product, index) => {
        const item = document.createElement('a');
        item.href = product.url;
        item.className = 'search-suggestion-item';
        item.setAttribute('role', 'option');
        item.setAttribute('aria-selected', 'false');
        item.setAttribute('data-index', index);

        const image = product.image ? 
          `<img src="${product.image}" alt="${product.title}" class="search-suggestion-image" />` : 
          '<div class="search-suggestion-image" style="background: #f0f0f0;"></div>';

        const price = product.price ? 
          `<div class="search-suggestion-price">${formatMoney(product.price)}</div>` : '';

        item.innerHTML = `
          ${image}
          <div class="search-suggestion-content">
            <div class="search-suggestion-title">${highlightMatch(product.title, query)}</div>
            ${price}
          </div>
        `;

        item.addEventListener('mouseenter', () => {
          setSelected(index);
        });

        item.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = product.url;
        });

        searchSuggestions.appendChild(item);
      });

      searchSuggestions.classList.add('has-results');

      function setSelected(index) {
        const items = searchSuggestions.querySelectorAll('.search-suggestion-item');
        items.forEach((item, i) => {
          item.setAttribute('aria-selected', i === index ? 'true' : 'false');
        });
        selectedIndex = index;
      }

      // Keyboard navigation
      searchInput.addEventListener('keydown', function(e) {
        const items = searchSuggestions.querySelectorAll('.search-suggestion-item');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          setSelected(selectedIndex);
          items[selectedIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          if (selectedIndex >= 0) {
            setSelected(selectedIndex);
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          searchSuggestions.classList.remove('has-results');
          searchInput.blur();
        }
      });
    }

    function highlightMatch(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<strong>$1</strong>');
    }

    function formatMoney(cents) {
      // Shopify returns price in cents
      const amount = typeof cents === 'string' ? parseFloat(cents) : cents;
      return new Intl.NumberFormat('pl-PL', {
        style: 'currency',
        currency: 'PLN',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount / 100);
    }

    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        performSearch(query);
      }, 300);
    });

    searchInput.addEventListener('focus', function() {
      const query = this.value.trim();
      if (query.length >= 2) {
        performSearch(query);
      }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.closest('.search-bar-container').contains(e.target)) {
        searchSuggestions.classList.remove('has-results');
      }
    });
  })();
</script>

